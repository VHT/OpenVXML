timestamps {
    gitCredentials = 'b8c95475-d39c-415a-a0e6-c8eefb05cd34'
    gitURL = 'http://github.com/VHT/OpenVXML.git'
    node ('ubuntu-18-04-jdk') {
        deleteDir()
        stage('Checkout') {
            checkout([
     	        $class: 'GitSCM',
         	     branches: [[name: '*/6.2.0']],
         	     doGenerateSubmoduleConfigurations: false,
         	     extensions: [],
         	     submoduleCfg: [],
         	     userRemoteConfigs: [
         	         [credentialsId: "${gitCredentials}", 
         	         url: "${gitURL}"]
         	     ]
         	])
        }
        stage('Build OpenVXML') {
            withEnv(["JAVA_HOME=${tool 'jdk8-191-oracle'}", "PATH+JAVA_HOME=${env.JAVA_HOME}/bin"]) {
                withMaven( maven: 'maven354' ) {
        
                    // Run the maven build
                    sh """
                        mvn clean verify
                        mkdir -p ${WORKSPACE}/OpenVXML/repository
                        cp -r com.vht.openvxml.releng/com.vht.openvxml.update/target/repository/ OpenVXML/
                        zip -r OpenVXML.zip OpenVXML/
                    """
        
                }
            }
            stash includes: 'OpenVXML.zip', name: 'OpenVXML'
        }
    }
    node ('win-2016') {
        deleteDir()
	    stage ('Publish OpenVXML') {
            unstash 'OpenVXML'
            bat """
                7z.exe x OpenVXML.zip
                rem Copy the OpenVXML
                xcopy /y /i /s /e "%WORKSPACE%\\OpenVXML" "C:\\Builds\\OpenVXML_Builds\\OpenVXML_%VERSION_NUMBER%.%BUILD_NUMBER%\\*" 
            """ 
        }
    }
}
